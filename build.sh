#!/bin/bash

SRC=""
SRC+=""
#SRC+="arch/um/kernel/skas/uaccess.o "
SRC+="arch/um/kernel/mem.o "
SRC+="arch/um/kernel/um_arch.o "
SRC+="arch/um/os-Linux/elf_aux.o "
SRC+="arch/x86/lib/atomic64_cx8_32.o "
SRC+="arch/x86/um/checksum_32.o "
SRC+="drivers/base/core.o "
#SRC+="crypto/api.o "
SRC+="fs/buffer.o "
SRC+="fs/dcache.o "
SRC+="fs/file.o "
SRC+="fs/file_table.o "
SRC+="fs/inode.o "
SRC+="fs/libfs.o "
SRC+="fs/locks.o "
#SRC+="fs/namei.o "
SRC+="fs/namespace.o "
SRC+="fs/fs_struct.o "
#SRC+="fs/fs-writeback.o "
#SRC+="fs/pipe.o "
#SRC+="fs/splice.o "
SRC+="init/init_task.o "
SRC+="init/main.o "
SRC+="init/version.o "
SRC+="ipc/msgutil.o "
SRC+="kernel/cred.o "
SRC+="kernel/groups.o "
#SRC+="kernel/locking/mutex.o "
SRC+="kernel/locking/rwsem-spinlock.o "
SRC+="kernel/nsproxy.o "
SRC+="kernel/pid.o "
SRC+="kernel/rcu/tiny.o "
SRC+="kernel/sys.o "
SRC+="kernel/sched/clock.o "
#SRC+="kernel/sched/core.o "
SRC+="kernel/sched/wait.o "
#SRC+="kernel/signal.o "
SRC+="kernel/softirq.o "
SRC+="kernel/time/time.o "
#SRC+="kernel/time/timekeeping.o "
SRC+="kernel/time/timer.o "
SRC+="kernel/user.o "
SRC+="lib/ctype.o "
SRC+="lib/dec_and_lock.o "
SRC+="lib/div64.o "
SRC+="lib/dynamic_queue_limits.o "
#SRC+="lib/dump_stack.o "
SRC+="lib/find_bit.o "
SRC+="lib/iov_iter.o "
SRC+="lib/kasprintf.o "
#SRC+="lib/kobject.o "
SRC+="lib/kstrtox.o "
SRC+="lib/md5.o "
#SRC+="lib/once.o "
SRC+="lib/random32.o "
SRC+="lib/rbtree.o "
SRC+="lib/string.o "
SRC+="lib/win_minmax.o "

SRC+="mm/bootmem.o "
SRC+="mm/init-mm.o "
SRC+="mm/memory.o "
#SRC+="mm/percpu.o "
#SRC+="mm/filemap.o "
SRC+="mm/vmstat.o "

SRC+="net/socket.o "
SRC+="net/core/datagram.o "
SRC+="net/core/dev.o "
SRC+="net/core/dev_addr_lists.o "
#SRC+="net/core/dst.o "
SRC+="net/core/filter.o "
SRC+="net/core/neighbour.o "
SRC+="net/core/request_sock.o "
SRC+="net/core/secure_seq.o "
SRC+="net/core/skbuff.o "
SRC+="net/core/sock.o "
#SRC+="net/core/sock_diag.o "
SRC+="net/core/sock_reuseport.o "
SRC+="net/core/stream.o "

SRC+="net/ethernet/eth.o "
SRC+="net/ipv4/af_inet.o "
SRC+="net/ipv4/arp.o "
SRC+="net/ipv4/datagram.o "
#SRC+="net/ipv4/devinet.o "
#SRC+="net/ipv4/fib_frontend.o "
SRC+="net/ipv4/icmp.o "
SRC+="net/ipv4/inet_connection_sock.o "
SRC+="net/ipv4/inet_fragment.o "
SRC+="net/ipv4/inet_hashtables.o "
SRC+="net/ipv4/inet_timewait_sock.o "
SRC+="net/ipv4/inetpeer.o "
SRC+="net/ipv4/ip_fragment.o "
SRC+="net/ipv4/ip_input.o "
SRC+="net/ipv4/ip_options.o "
SRC+="net/ipv4/ip_output.o "
SRC+="net/ipv4/ip_sockglue.o "
SRC+="net/ipv4/protocol.o "
#SRC+="net/ipv4/route.o "
SRC+="net/ipv4/raw.o "
SRC+="net/ipv4/tcp.o "
SRC+="net/ipv4/tcp_cong.o "
SRC+="net/ipv4/tcp_fastopen.o "
SRC+="net/ipv4/tcp_input.o "
SRC+="net/ipv4/tcp_ipv4.o "
#SRC+="net/ipv4/tcp_metrics.o "		# XXX
SRC+="net/ipv4/tcp_minisocks.o "
SRC+="net/ipv4/tcp_output.o "
SRC+="net/ipv4/tcp_rate.o "
SRC+="net/ipv4/tcp_recovery.o "
SRC+="net/ipv4/tcp_timer.o "
SRC+="net/ipv4/udp.o "
SRC+="net/netlink/af_netlink.o "

SRC+="study/stub_arch.o "
SRC+="study/stub_fs.o "
SRC+="study/stub_kernel.o "
SRC+="study/stub_mm.o "
SRC+="study/stub_net.o "
SRC+="study/fake.o "
SRC+="study/helper.o "

set -x
$L make ARCH=um $SRC $*
gcc -m32 -Wall -g -c study/pcap.c -o study/pcap.o
g++ -m32 -g study/main.cc study/lib.cc study/pcap.o -Wall -Wl,--gc-sections $SRC -o tcp

